mapboxgl.accessToken = 'YOUR_EMIIA_AI_ACCESS_TOKEN';

const map = new mapboxgl.Map({
    container: 'map', 
    style: 'https://sos.emiia.ai/moscow_style_2.json',
    zoom: 18.3,
    minZoom: 9,
    maxZoom: 20.5,
    center: [37.63567614,55.83837533],
    hash: true,
    turn: false,
    attributionControl: false,
    bearing: 0,
    pitch: 45,
    antialias: true 
});

// Переменные для состояния
let isLocationActive = false;
let compassHideTimer;

// Синяя точка с волнами #3d85c6 - размер 110px
const pulsingDotBlue = {
    width: 110,
    height: 110,
    data: new Uint8Array(110 * 110 * 4),

    onAdd: function () {
        const canvas = document.createElement('canvas');
        canvas.width = this.width;
        canvas.height = this.height;
        this.context = canvas.getContext('2d', { willReadFrequently: true });
    },

    render: function () {
        const duration = 1800;
        const pulseDuration = 700;
        const t = (performance.now() % duration) / duration;
        const pulseT = (performance.now() % pulseDuration) / pulseDuration;
        const context = this.context;

        context.clearRect(0, 0, this.width, this.height);

        const centerX = this.width / 2;
        const centerY = this.height / 2;
        const maxRadius = this.width / 2 * 1;
        const sweepAngle = Math.PI * 2 * 1.7 * t;
        const opacity = 0.8 * Math.pow(1 - t, 2);

        context.beginPath();
        context.moveTo(centerX, centerY);
        context.arc(centerX, centerY, maxRadius, Math.PI / 2, sweepAngle + Math.PI / 2);
        context.closePath();

        context.fillStyle = `rgba(61, 133, 198, ${opacity})`;
        context.fill();

        const radius = (this.width / 2) * 0.35;
        context.beginPath();
        context.arc(centerX, centerY, radius, 0, Math.PI * 2);
        context.fillStyle = 'rgba(61, 133, 198, 1)';
        context.strokeStyle = '#f8f9fa';

        context.lineWidth = 4 + 4 * Math.abs(Math.sin(Math.PI * pulseT));
        context.fill();
        context.stroke();

        this.data = context.getImageData(0, 0, this.width, this.height).data;
        map.triggerRepaint();

        return true;
    }
};

// Создаем кастомный компас с твоим SVG
function createCustomCompass() {
    // Удаляем старый компас если есть
    const oldCompass = document.getElementById('custom-compass');
    if (oldCompass) {
        oldCompass.remove();
    }

    const compass = document.createElement('button');
    compass.id = 'custom-compass';
    
    // Твой SVG компас с увеличенным размером
    compass.innerHTML = `
        <svg
            xmlns="http://www.w3.org/2000/svg"
            class="compass-icon"
            stroke-linejoin="round"
            stroke-linecap="round"
            stroke-width="0.8"
            stroke="#3d85c6"
            stroke-opacity="0.8"
            viewBox="0 0 15 15"
            fill="transparent"
            height="22"
            width="22">
            <path
                fill="transparent"
                stroke="#3d85c6"
                stroke-width="2"
                id="compass-path"
                d="M 8.0541549,2.4921492 A 0.5,0.40619867 0 0 1 8.521609,2.7520459 l 5.03092,10.5515841 a 0.5,0.40619867 0 0 1 -0.651832,0.524015 L 8.0828433,12.271588 3.272759,13.846285 A 0.5,0.40619867 0 0 1 2.6192748,13.324799 L 7.5882307,2.753853 A 0.5,0.40619867 0 0 1 8.0534494,2.4927249 Z" />
        </svg>
    `;
    
    compass.style.cssText = `
        position: absolute;
        top: 40%;
        left: 10px;
        width: 44px;
        height: 44px;
        background: transparent;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-50%);
        -webkit-tap-highlight-color: transparent;
        outline: none;
        pointer-events: auto;
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
    `;

    // Простой обработчик клика без сложных preventDefault
    compass.addEventListener('click', function(e) {
        e.stopPropagation();
        if (isLocationActive) {
            removeUserLocation();
        } else {
            locateUser();
        }
    });

    // Для iOS добавляем обработчик touchstart
    compass.addEventListener('touchstart', function(e) {
        e.stopPropagation();
    }, { passive: true });

    compass.title = 'Показать мое местоположение';

    // Добавляем компас в контейнер карты, а не в body
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        mapContainer.appendChild(compass);
    } else {
        document.body.appendChild(compass);
    }
    
    return compass;
}

// Обработчик клика по кастомному компасу
function handleCompassClick(e) {
    e.stopPropagation();
    
    if (isLocationActive) {
        removeUserLocation();
    } else {
        locateUser();
    }
}

// Функция для удаления точки местоположения
function removeUserLocation() {
    if (map.getSource('user-location')) {
        map.removeLayer('user-location-layer');
        map.removeSource('user-location');
    }
    isLocationActive = false;
    updateCompassAppearance();
}

// Функция для обновления внешнего вида компаса
function updateCompassAppearance() {
    const compass = document.getElementById('custom-compass');
    const compassPath = document.getElementById('compass-path');
    const compassIcon = document.querySelector('.compass-icon');
    
    if (compass && compassPath && compassIcon) {
        if (isLocationActive) {
            // Активное состояние - синий fill
            compassPath.setAttribute('fill', '#3d85c6');
            compassIcon.setAttribute('fill', '#3d85c6');
            compass.style.backgroundColor = 'transparent';
            compass.title = 'Скрыть мое местоположение';
        } else {
            // Неактивное состояние - прозрачный fill
            compassPath.setAttribute('fill', 'transparent');
            compassIcon.setAttribute('fill', 'transparent');
            compass.style.backgroundColor = 'transparent';
            compass.title = 'Показать мое местоположение';
        }
    }
}

// Функция для показа компаса
function showCompass() {
    const compass = document.getElementById('custom-compass');
    if (compass) {
        clearTimeout(compassHideTimer);
        compass.style.opacity = '1';
        compass.style.visibility = 'visible';
        // Принудительно включаем pointer-events
        compass.style.pointerEvents = 'auto';
    }
}

// Функция для скрытия компаса (только если не активно местоположение)
function hideCompass() {
    if (!isLocationActive) {
        const compass = document.getElementById('custom-compass');
        if (compass) {
            compass.style.opacity = '0';
            compass.style.visibility = 'hidden';
        }
    }
}

// Функция для определения местоположения
function locateUser() {
    if (!navigator.geolocation) {
        alert('Геолокация не поддерживается вашим браузером');
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const { longitude, latitude } = position.coords;
            
            map.flyTo({
                center: [longitude, latitude],
                zoom: 17,
                duration: 2000,
                essential: true
            });

            removeUserLocation();

            map.addImage('pulsing-dot-blue', pulsingDotBlue, { pixelRatio: 2 });
            
            map.addSource('user-location', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: [
                        {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [longitude, latitude]
                            }
                        }
                    ]
                }
            });

            map.addLayer({
                id: 'user-location-layer',
                type: 'symbol',
                source: 'user-location',
                layout: {
                    'icon-image': 'pulsing-dot-blue',
                    'icon-allow-overlap': true,
                    'icon-ignore-placement': true
                }
            });

            isLocationActive = true;
            updateCompassAppearance();
            showCompass();

        },
        (error) => {
            let errorMessage = 'Не удалось определить местоположение';
            
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Доступ к геолокации запрещен. Разрешите доступ в настройках браузера.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Информация о местоположении недоступна.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Время ожидания определения местоположения истекло.';
                    break;
            }
            
            alert(errorMessage);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

// Создаем компас при загрузке
createCustomCompass();

// Обновляем вращение кастомного компаса
map.on('rotate', function() {
    const compass = document.getElementById('custom-compass');
    if (compass) {
        const bearing = map.getBearing();
        const compassIcon = compass.querySelector('.compass-icon');
        if (compassIcon) {
            compassIcon.style.transform = `rotate(${-bearing}deg)`;
        }
    }
});

// Ограничиваем наклон иконки компаса
map.on('pitch', function() {
    const compass = document.getElementById('custom-compass');
    if (compass) {
        const currentPitch = map.getPitch();
        const maxCompassPitch = 0;
        const limitedPitch = Math.min(currentPitch, maxCompassPitch);
        
        compass.style.transform = `translateY(-50%) perspective(500px) rotateX(${limitedPitch}deg)`;
    }
});

// Показываем компас при начале поворота
map.on('rotatestart', function() {
    showCompass();
});

// Скрываем компас через 7 секунд после окончания поворота
map.on('rotateend', function() {
    if (!isLocationActive) {
        compassHideTimer = setTimeout(() => {
            hideCompass();
        }, 7000);
    }
});

// Также показываем компас при клике на карту
map.on('click', function(e) {
    showCompass();
    
    if (!isLocationActive) {
        clearTimeout(compassHideTimer);
        compassHideTimer = setTimeout(() => {
            hideCompass();
        }, 7000);
    }
});

map.on('load', () => {
    console.log('Карта загружена');
});
