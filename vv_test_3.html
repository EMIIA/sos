<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Находим оригинальную кнопку и ее контейнер
        const emiiaButton = document.getElementById('emiiaButton');
        const emiiaMenu = document.getElementById('emiiaMenu');
        const originalContainer = emiiaButton.parentElement;
        
        // Сохраняем оригинальные стили контейнера
        const originalStyles = window.getComputedStyle(originalContainer);
        
        // Создаем новый контейнер для двух кнопок
        const newContainer = document.createElement('div');
        newContainer.style.cssText = originalContainer.style.cssText;
        newContainer.className = originalContainer.className;
        newContainer.style.display = 'flex';
        newContainer.style.alignItems = 'center';
        newContainer.style.gap = '10px';

        // Кнопка 1: Точки (новая) - СЛЕВА - БЕЛЫЕ ВЕРТИКАЛЬНЫЕ ТОЧКИ БЕЗ КРУГА
        const dotsButton = document.createElement('button');
        dotsButton.id = 'dotsButton';
        dotsButton.innerHTML = '⋮';
        dotsButton.style.cssText = `
            background: transparent;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        `;

        // Кнопка 2: Основное меню (оригинальная) - СПРАВА
        const mainButton = emiiaButton.cloneNode(true);
        mainButton.id = 'mainButton';
        mainButton.style.margin = '0';

        // Добавляем кнопки в новый контейнер
        newContainer.appendChild(dotsButton);
        newContainer.appendChild(mainButton);
        
        // Заменяем оригинальный контейнер
        originalContainer.parentNode.replaceChild(newContainer, originalContainer);

        // Создаем меню точек
        const dotsMenu = document.createElement('div');
        dotsMenu.id = 'dotsMenu';
        dotsMenu.style.cssText = `
            display: none;
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 10px;
            z-index: 10000;
            min-width: 150px;
        `;
        dotsMenu.innerHTML = `
            <div class="menu-item" data-action="refresh">Обновить</div>
            <div class="menu-item" data-action="settings">Настройки</div>
            <div class="menu-item" data-action="install">Установить</div>
            <div class="menu-item" data-action="terms">Условия</div>
            <div class="menu-item" data-action="privacy">Конфиденциальность</div>
        `;
        document.body.appendChild(dotsMenu);

        // Создаем оверлей с pointer-events: auto (блокирует события)
        const dotsOverlay = document.createElement('div');
        dotsOverlay.id = 'dotsOverlay';
        dotsOverlay.style.cssText = `
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            z-index: 9998;
            pointer-events: auto; /* Оверлей БЛОКИРУЕТ события */
        `;
        document.body.appendChild(dotsOverlay);

        // Стили для пунктов меню
        const style = document.createElement('style');
        style.textContent = `
            .menu-item {
                padding: 10px 15px;
                cursor: pointer;
                border-radius: 5px;
                transition: background 0.2s;
                color: #333;
                font-family: sans-serif;
            }
            .menu-item:hover {
                background: #f0f0f0;
            }
            #dotsOverlay {
                z-index: 9998;
            }
            #dotsMenu {
                z-index: 10000;
            }
            #dotsButton {
                z-index: 10001;
            }
        `;
        document.head.appendChild(style);

        // ========== СИСТЕМА 1: ОСНОВНОЕ МЕНЮ ==========
        function toggleMainMenu() {
            const isActive = emiiaMenu.classList.contains('active');
            if (isActive) {
                closeMainMenu();
            } else {
                openMainMenu();
            }
        }

        function openMainMenu() {
            emiiaMenu.classList.add('active');
            mainButton.classList.add('active');
        }

        function closeMainMenu() {
            emiiaMenu.classList.remove('active');
            mainButton.classList.remove('active');
        }

        mainButton.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleMainMenu();
        });

        // ========== СИСТЕМА 2: МЕНЮ ТОЧЕК С ОВЕРЛЕЕМ ==========
        function toggleDotsMenu() {
            const isVisible = dotsMenu.style.display === 'block';
            if (isVisible) {
                closeDotsMenu();
            } else {
                openDotsMenu();
            }
        }

        function openDotsMenu() {
            const containerRect = newContainer.getBoundingClientRect();
            
            dotsMenu.style.bottom = (window.innerHeight - containerRect.top + 10) + 'px';
            dotsMenu.style.left = (containerRect.left) + 'px';
            dotsMenu.style.top = 'auto';
            
            dotsMenu.style.display = 'block';
            dotsOverlay.style.display = 'block';
        }

        function closeDotsMenu() {
            dotsMenu.style.display = 'none';
            dotsOverlay.style.display = 'none';
        }

        dotsButton.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleDotsMenu();
        });

        dotsMenu.addEventListener('click', function(e) {
            if (e.target.classList.contains('menu-item')) {
                const action = e.target.getAttribute('data-action');
                closeDotsMenu();
                
                switch(action) {
                    case 'refresh': location.reload(); break;
                    case 'settings': window.open('https://emiia.ai', '_blank'); break;
                    case 'install': window.location.href = 'https://sos.emiia.ai/vv3.html'; break;
                    case 'terms': window.open('https://emiia.ai/terms', '_blank'); break;
                    case 'privacy': window.open('https://emiia.ai/privacy', '_blank'); break;
                }
            }
        });

        // ========== ПРАВИЛЬНАЯ ЛОГИКА ОВЕРЛЕЯ ==========
        dotsOverlay.addEventListener('click', function(e) {
            e.stopPropagation();
            closeDotsMenu();
        });

        dotsOverlay.addEventListener('touchstart', function(e) {
            e.stopPropagation();
            closeDotsMenu();
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && dotsMenu.style.display === 'block') {
                closeDotsMenu();
            }
        });

        // ========== ВСЕ ВОЗМОЖНЫЕ СОБЫТИЯ ДЛЯ ЗАКРЫТИЯ МЕНЮ ==========

        // Закрытие при клике в любом месте документа (кроме оверлея и кнопки)
        document.addEventListener('click', function(e) {
            if (dotsMenu.style.display === 'block' && 
                !dotsMenu.contains(e.target) && 
                !dotsButton.contains(e.target) &&
                e.target !== dotsOverlay) {
                closeDotsMenu();
            }
        });

        // Закрытие при скролле
        window.addEventListener('scroll', closeDotsMenu);

        // Закрытие при изменении размера окна
        window.addEventListener('resize', closeDotsMenu);

        // Закрытие при касании на мобильных (кроме оверлея и кнопки)
        document.addEventListener('touchstart', function(e) {
            if (dotsMenu.style.display === 'block' && 
                !dotsMenu.contains(e.target) && 
                !dotsButton.contains(e.target) &&
                e.target !== dotsOverlay) {
                closeDotsMenu();
            }
        });

        // Закрытие при событиях карты
        if (window.map) {
            const mapEvents = [
                'mousedown', 'mouseup', 'click', 'dblclick', 'contextmenu',
                'touchstart', 'touchend', 'touchmove', 'touchcancel',
                'movestart', 'move', 'moveend', 'moving',
                'zoomstart', 'zoom', 'zoomend', 'zooming',
                'rotatestart', 'rotate', 'rotateend', 'rotating',
                'dragstart', 'drag', 'dragend', 'dragging',
                'boxzoomstart', 'boxzoomend', 'boxzoomcancel',
                'mouseover', 'mouseout', 'mousemove',
                'wheel', 'load', 'idle', 'error'
            ];
            
            mapEvents.forEach(eventType => {
                map.on(eventType, closeDotsMenu);
            });
        }

        // Закрытие при изменении ориентации устройства
        window.addEventListener('orientationchange', closeDotsMenu);

        // Закрытие при потере фокуса
        window.addEventListener('blur', closeDotsMenu);

    });
</script>
