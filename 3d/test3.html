<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>3D Точка по линии</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
        }
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 100%; 
            background: #f8f9fa; 
        }
    </style>
    <script src="https://sos.emiia.ai/mapbox-gl.js"></script>
    <link href="https://sos.emiia.ai/mapbox-gl.css" rel="stylesheet">
    <link href="https://sos.emiia.ai/css.css" rel="stylesheet">
</head>
<body>
<div id="map"></div>
<script>
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
console.log('Мобильное устройство:', isMobile);

mapboxgl.accessToken = 'YOUR_EMIIA_AI_ACCESS_TOKEN';

// Координаты и настройки
const lineCoordinates = [
    [37.630507, 55.833692],
    [37.630877, 55.834026],
    [37.631323, 55.834250],
    [37.631735, 55.834216]
];

const objectSettings = {
    object1: {
        pointColor: '#6fa8dc',
        lineColor: '#3d85c6',
        size: 140,
        animationSpeed: 0.0007,
        elevations: [15, 25, 30, 35],
        modelUri: 'https://sos.emiia.ai/circle_2_glb.glb',
        baseOpacity: 1.0,
        verticalOffset: 0.02
    },
    object2: {
        pointColor: '#f6f6f6',
        lineColor: '#d3d3d3',
        baseSize: 190,
        animationSpeed: 0.0007,
        elevations: [14.98, 24.98, 29.98, 34.98],
        modelUri: 'https://sos.emiia.ai/circle_2_glb.glb',
        baseOpacity: 1.0,
        pulseMin: 0.92,
        pulseMax: 1.08,
        verticalOffset: 0.01
    },
    object3: {
        pointColor: '#3d85c6',
        lineColor: '#3d85c6',
        baseSize: 180,
        animationSpeed: 0.0007,
        elevations: [14.9, 24.9, 29.9, 34.9],
        modelUri: 'https://sos.emiia.ai/circle_2_glb.glb',
        baseOpacity: 0.6,
        verticalOffset: 0.00
    }
};

const map = new mapboxgl.Map({
    container: 'map',
    style: 'https://sos.emiia.ai/3d/tiles.json',
    minZoom: 17,
    center: lineCoordinates[0],
    zoom: 18,
    pitch: 60,
    bearing: 30,
    antialias: true
});

// ЕДИНЫЙ контроллер анимации
class AnimationController {
    constructor() {
        this.progress = 0;
        this.direction = 1;
        this.isMoving = true;
        this.currentSegment = 0;
        this.pulseTime = performance.now();
        this.lastTimestamp = 0;
        this.zoomSettings = { minZoom: 15, maxZoom: 22 };
        this.currentBaseSize = 1.0;
        
        this.lastState = {
            obj1: { position: null, scale: null, opacity: null },
            obj2: { position: null, scale: null, opacity: null },
            obj3: { position: null, scale: null, opacity: null }
        };
    }

    updateZoom() {
        const zoom = map.getZoom();
        const oldSize = this.currentBaseSize;
        
        if (zoom <= this.zoomSettings.minZoom) {
            this.currentBaseSize = 1.0;
        } else if (zoom >= this.zoomSettings.maxZoom) {
            this.currentBaseSize = 0.3;
        } else {
            const normalizedZoom = (zoom - this.zoomSettings.minZoom) / (this.zoomSettings.maxZoom - this.zoomSettings.minZoom);
            this.currentBaseSize = 1.0 - (normalizedZoom * 0.7);
        }

        if (this.currentBaseSize !== oldSize) {
            this.updateAllScales();
        }
    }

    updateAllScales() {
        [objectSettings.object1, objectSettings.object2, objectSettings.object3].forEach((obj, i) => {
            const layerId = `object-layer-${i + 1}`;
            const baseSize = obj.size || obj.baseSize;
            const finalSize = baseSize * this.currentBaseSize;
            map.setPaintProperty(layerId, 'model-scale', [finalSize, finalSize, finalSize]);
        });
    }

    getPulseState(stamp, isObject3) {
        const cycleProgress = ((stamp - this.pulseTime) % 1800) / 1800;
        
        if (cycleProgress < 0.833) {
            const animProgress = cycleProgress / 0.833;
            
            if (isObject3) {
                return {
                    scale: 1 + (animProgress * 2.0),
                    opacity: Math.max(0.1, 0.6 * (1 - animProgress * 0.9))
                };
            } else {
                const pulseRange = 1.08 - 0.92;
                return {
                    scale: 0.92 + (Math.sin(animProgress * Math.PI * 3) * pulseRange * 0.5),
                    opacity: 1.0
                };
            }
        }
        
        return isObject3 ? { scale: 1, opacity: 0.1 } : { scale: 1, opacity: 1.0 };
    }

    updatePosition(sourceId, layerId, coords, elevation, offset) {
        const source = map.getSource(sourceId);
        if (!source) return;

        const key = sourceId.includes('-1') ? 'obj1' : sourceId.includes('-2') ? 'obj2' : 'obj3';
        const posKey = `${coords[0].toFixed(9)}-${coords[1].toFixed(9)}-${elevation.toFixed(3)}`;
        
        if (this.lastState[key].position !== posKey) {
            const data = source._data || source.data;
            data.geometry.coordinates = coords;
            source.setData(data);
            this.lastState[key].position = posKey;
        }

        const translation = [0, 0, elevation + offset];
        map.setPaintProperty(layerId, 'model-translation', translation);
    }

    updateScale(layerId, scale, key) {
        const scaleKey = `${scale[0].toFixed(3)}-${scale[1].toFixed(3)}-${scale[2].toFixed(3)}`;
        if (this.lastState[key].scale !== scaleKey) {
            map.setPaintProperty(layerId, 'model-scale', scale);
            this.lastState[key].scale = scaleKey;
        }
    }

    updateOpacity(layerId, opacity, key) {
        const opacityKey = opacity.toFixed(3);
        if (this.lastState[key].opacity !== opacityKey) {
            map.setPaintProperty(layerId, 'model-opacity', opacity);
            this.lastState[key].opacity = opacityKey;
        }
    }

    animate(timestamp) {
        if (!this.lastTimestamp) this.lastTimestamp = timestamp;
        const deltaTime = Math.min(timestamp - this.lastTimestamp, 32);
        this.lastTimestamp = timestamp;

        // 1. ПУЛЬСАЦИЯ ОБЪЕКТОВ 2 и 3
        const state2 = this.getPulseState(timestamp, false);
        const state3 = this.getPulseState(timestamp, true);

        const size2 = objectSettings.object2.baseSize * this.currentBaseSize * state2.scale;
        this.updateScale('object-layer-2', [size2, size2, size2], 'obj2');
        this.updateOpacity('object-layer-2', state2.opacity, 'obj2');

        const size3 = objectSettings.object3.baseSize * this.currentBaseSize * state3.scale;
        this.updateScale('object-layer-3', [size3, size3, size3], 'obj3');
        this.updateOpacity('object-layer-3', state3.opacity, 'obj3');

        // 2. ДВИЖЕНИЕ ВСЕХ ТОЧЕК
        if (this.isMoving) {
            this.progress += objectSettings.object1.animationSpeed * this.direction * (deltaTime / 16);

            const newSegment = Math.floor(this.progress * (lineCoordinates.length - 1));
            
            if (newSegment !== this.currentSegment && 
                newSegment > 0 && newSegment < lineCoordinates.length - 1) {
                this.currentSegment = newSegment;
                this.isMoving = false;
                setTimeout(() => { this.isMoving = true; }, 2000);
            }

            if (this.progress >= 1 && this.direction === 1) {
                this.progress = 0.999;
                this.isMoving = false;
                setTimeout(() => { this.direction = -1; this.isMoving = true; }, 2000);
            } else if (this.progress <= 0 && this.direction === -1) {
                this.progress = 0.001;
                this.isMoving = false;
                setTimeout(() => { this.direction = 1; this.isMoving = true; }, 2000);
            }

            this.progress = Math.max(0, Math.min(1, this.progress));

            const segmentIndex = Math.min(Math.floor(this.progress * (lineCoordinates.length - 1)), lineCoordinates.length - 2);
            const segmentProgress = (this.progress * (lineCoordinates.length - 1)) - segmentIndex;

            const startCoord = lineCoordinates[segmentIndex];
            const endCoord = lineCoordinates[segmentIndex + 1];
            const currentLng = startCoord[0] + (endCoord[0] - startCoord[0]) * segmentProgress;
            const currentLat = startCoord[1] + (endCoord[1] - startCoord[1]) * segmentProgress;

            // Обновляем позиции ВСЕХ трех объектов
            this.updatePosition('object-model-1', 'object-layer-1', 
                [currentLng, currentLat], 
                objectSettings.object1.elevations[segmentIndex] + 
                (objectSettings.object1.elevations[segmentIndex + 1] - objectSettings.object1.elevations[segmentIndex]) * segmentProgress,
                objectSettings.object1.verticalOffset);

            this.updatePosition('object-model-2', 'object-layer-2', 
                [currentLng, currentLat], 
                objectSettings.object2.elevations[segmentIndex] + 
                (objectSettings.object2.elevations[segmentIndex + 1] - objectSettings.object2.elevations[segmentIndex]) * segmentProgress,
                objectSettings.object2.verticalOffset);

            this.updatePosition('object-model-3', 'object-layer-3', 
                [currentLng, currentLat], 
                objectSettings.object3.elevations[segmentIndex] + 
                (objectSettings.object3.elevations[segmentIndex + 1] - objectSettings.object3.elevations[segmentIndex]) * segmentProgress,
                objectSettings.object3.verticalOffset);
        }

        requestAnimationFrame((ts) => this.animate(ts));
    }

    start() {
        this.updateAllScales();
        this.animate(performance.now());
    }
}

const animator = new AnimationController();

map.on('style.load', () => {
    // Terrain
    map.addSource('mapbox-dem', {
        'type': 'raster-dem',
        'url': 'https://sos.emiia.ai/3d/3d_tiles.json',
        'tileSize': 51,
        'maxzoom': 24
    });
    map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 0.0 });

    // ЛИНИИ С ЭЛЕВАЦИЕЙ
    ['elevated-line-1', 'elevated-line-2', 'elevated-line-3'].forEach((id, i) => {
        const obj = [objectSettings.object1, objectSettings.object2, objectSettings.object3][i];
        
        map.addSource(id, {
            'type': 'geojson',
            'lineMetrics': true,
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': { 'coordinates': lineCoordinates, 'type': 'LineString' }
            }
        });

        map.addLayer({
            'id': id,
            'type': 'line',
            'source': id,
            'layout': {
                'line-z-offset': ['interpolate', ['linear'], ['line-progress'], 0, obj.elevations[0], 1, obj.elevations[obj.elevations.length-1]],
                'line-elevation-reference': 'sea'
            },
            'paint': {
                'line-emissive-strength': 1.0,
                'line-width': 4.0,
                'line-color': obj.lineColor
            }
        });
    });

    // Модели
    [objectSettings.object1, objectSettings.object2, objectSettings.object3].forEach((obj, i) => {
        const layerId = `object-layer-${i + 1}`;
        const sourceId = `object-model-${i + 1}`;
        
        map.addSource(sourceId, {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': { 'model-uri': obj.modelUri },
                'geometry': { 'coordinates': lineCoordinates[0], 'type': 'Point' }
            }
        });

        const baseSize = obj.size || obj.baseSize;
        map.addLayer({
            'id': layerId,
            'type': 'model',
            'slot': 'middle',
            'source': sourceId,
            'minzoom': 10,
            'maxzoom': 24,
            'layout': {
                'model-id': ['get', 'model-uri']
            },
            'paint': {
                'model-opacity': obj.baseOpacity,
                'model-rotation': [0, 0, 0],
                'model-scale': [baseSize, baseSize, baseSize],
                'model-color': obj.pointColor,
                'model-color-mix-intensity': 0.8,
                'model-cast-shadows': false,
                'model-translation': [0, 0, obj.elevations[0] + obj.verticalOffset],
                'model-emissive-strength': 1.0,
                'model-scale-mode': 'map'
            }
        });
    });

    // Зум
    let zoomTimeout;
    map.on('zoom', () => {
        clearTimeout(zoomTimeout);
        zoomTimeout = setTimeout(() => animator.updateZoom(), 100);
    });

    // Запуск анимации
    map.once('idle', () => {
        setTimeout(() => {
            animator.start();
            console.log('✅ Анимация запущена!');
        }, isMobile ? 2500 : 1500);
    });

    // === ЗДАНИЯ И ПОЛИГОНЫ (ДОБАВЛЕНО СРАЗУ ПОСЛЕ ЗАПУСКА АНИМАЦИИ) ===
    if (!map.getSource('moscow')) {
        map.addSource('moscow', {
            url: 'EMIIA_AI',
            type: 'vector',
        });
        console.log('Источник moscow добавлен');
    }

    const layers = map.getStyle().layers;
    let labelLayerId;
    for (let i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
            labelLayerId = layers[i].id;
            break;
        }
    }

    // Добавляем слои зданий
    try {
        map.addLayer({
            'id': 'green-base',
            'source': 'moscow',
            'source-layer': 'building',
            'type': 'fill',
            'minzoom': 14,
            'maxzoom': 24,
            'paint': {
                'fill-color': '#a4c2f4',
                'fill-opacity': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    14, 0.3,
                    15.5, 0.3,
                    18, 0.3,
                    22, 0.3
                ]
            }
        }, labelLayerId);

        map.addLayer({
            'id': 'building-outlines',
            'source': 'moscow',
            'source-layer': 'building',
            'type': 'line',
            'minzoom': 14,
            'maxzoom': 24,
            'paint': {
                'line-color': '#ffffff',
                'line-width': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    14, 1,
                    16, 2,
                    18, 2,
                    20, 5
                ],
                'line-opacity': 1
            }
        }, labelLayerId);

        map.addLayer({
            'id': '3d-buildings',
            'source': 'moscow',
            'source-layer': 'building',
            'type': 'fill-extrusion',
            'minzoom': 14,
            'maxzoom': 19,
            'paint': {
                'fill-extrusion-color': '#e4e4e4',
                'fill-extrusion-height': ['interpolate', ['linear'], ['zoom'], 14, 0, 15.5, ['get', 'render_height']],
                'fill-extrusion-base': ['case', ['>=', ['get', 'zoom'], 16.5], ['get', 'render_min_height'], 0],
                'fill-extrusion-opacity': ['interpolate', ['linear'], ['zoom'], 14, 0, 15.5, 0.8, 18, 0.0]
            }
        }, labelLayerId);

        console.log('✅ Слои зданий добавлены');
    } catch (e) {
        console.error('Ошибка при добавлении слоев зданий:', e);
    }

    // Полигон
    map.addSource('polygon-source', {
        type: 'geojson',
        data: {
            type: 'Feature',
            geometry: {
                type: 'Polygon',
                coordinates: [[
                    [37.174014825136595, 55.97747637225763],
                    [37.174223117007614, 55.97745607738463],
                    [37.17408018404612, 55.97699461722809],
                    [37.173873474273904, 55.977014791684724],
                    [37.174014825136595, 55.97747637225763]
                ]]
            },
            properties: { height: 6.9 }
        }
    });

    map.addLayer({
        'id': 'extruded-polygon',
        'type': 'fill-extrusion',
        'source': 'polygon-source',
        'paint': {
            'fill-extrusion-color': '#e4e4e4',
            'fill-extrusion-height': ['get', 'height'],
            'fill-extrusion-base': 3.85,
            'fill-extrusion-opacity': ['interpolate', ['linear'], ['zoom'], 17.9, 0.007, 18.0, 0.009, 18.1, 0.2],
            'fill-extrusion-ambient-occlusion-intensity': 0
        }
    });

    map.setLight({ intensity: 0.1 });
});
</script>
</body>
</html>
