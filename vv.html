<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>–ü–†–û–°–¢–†–ê–ù–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢</title>

<!-- PWA -->
<link rel="shortcut icon" href="/vv.ico" type="image/x-icon">
<meta name="theme-color" content="#f8f9fa">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="/vv.webmanifest">

<!-- –°—Ç–∏–ª–∏ -->
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:monospace;margin:0;padding:0;min-height:100vh;display:flex;justify-content:center;align-items:center;background:#F8F9FA;padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
    .main-container{width:100%;max-width:100%;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .auth-container{background:white;padding:2rem;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.12);width:100%;max-width:400px;margin:0 auto;font-family:monospace}
    h2{color:#da4216;margin:0 0 1.5rem 0;text-align:center;font-size:1.8rem;font-family:monospace}
    .input-group{margin-bottom:1.2rem;font-family:monospace}
    input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;transition:border-color .3s ease;box-sizing:border-box;font-family:monospace;letter-spacing:2px}
    input:focus{outline:none;border-color:#6d9eeb;box-shadow:0 0 0 3px rgba(52,152,219,.1)}
    button{width:100%;padding:14px;background:#6d9eeb;color:white;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:background .3s ease;font-family:monospace;margin-top:.5rem}
    button:hover{background:#3c78d8}
    .text-primary{color:#6d9eeb;text-decoration:none}
    .text-primary1{text-decoration:none;text-align:center;display:block}
    .beta{font-size:.4em}
    img{max-width:100%;height:auto}
    p.small{font-size:.8rem}
    
    /* üé≠ –°–¢–ò–õ–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê */
    #push-modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    #push-modal > div {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        text-align: center;
        max-width: 90%;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    #subscribe-push-btn {
        padding: 14px 32px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
    }
    
    @media (max-width:768px){
        .main-container{padding:15px;align-items:flex-start;padding-top:max(20px,env(safe-area-inset-top))}
        .auth-container{padding:1.5rem;margin:0;max-width:100%;width:100%}
        h2{font-size:1.5rem;margin-bottom:1.2rem}
        input{letter-spacing:4.5px;font-size:16px}
        .auth-container{transform:translateZ(0)}
    }
    @media (max-height:600px){
        .main-container{align-items:flex-start;padding-top:10px}
        .auth-container{padding:1.2rem}
    }
    @media (min-width:1024px){
        body{min-height:100vh;overflow:hidden}
        .main-container{min-height:100vh}
    }
</style>
</head>
<body>

    <!-- üé≠ –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
    <div id="push-modal">
        <div>
            <h3>üîî –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</h3>
            <p>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç EMIIA.AI</p>
            <button id="subscribe-push-btn">–ü–û–õ–£–ß–ê–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</button>
            <button onclick="hidePushModal()" style="margin-left:1rem;background:#6c757d">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div class="main-container">
        <div class="auth-container">
            <div class="header-wrapper">
                <h2>
                    <a class="text-primary1" href="https://www.emiia.ru/">                    
                        <img src="/logo_wms.svg" alt="AI WMS" width="230" height="75" loading="eager">
                    </a>
                </h2>
            </div>

            <form id="auth-form">
                <div class="input-group">
                    <input type="text" id="login" name="username" placeholder="Email address" autocomplete="username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" name="password" placeholder="Password" autocomplete="current-password" required>
                </div>
                <p class="small"><a class="text-primary" href="mailto:emiia@emiia.ai">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a></p>
                <button type="submit">–í–û–ô–¢–ò <span>‚ùØ</span></button>
            </form>

            <p style="margin-top:1rem">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a class="text-primary" href="mailto:emiia@emiia.ai">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
            
            <div style="text-align:center;margin-top:2rem">
                <a class="text-primary1" href="https://www.emiia.ru/" style="color:#da4216;font-weight:600;text-decoration:none">
                    <span style="color:#b2b4b3;font-size:1rem;font-weight:500">–ü–†–û–°–¢–†–ê–ù–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢</span>
                    <span style="font-size:1rem;font-weight:600;color:#3c78d8;margin-left:2px"> ‚Ä¢ ‚ùØ</span>
                </a>
            </div>
        </div>
    </div>

    <script>
    // ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ë–ï–ó –ü–†–û–ë–ï–õ–û–í!)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz0wJrj3cyVhdLZrCtw3u0eO5nqklpEs-lc4vkvyz2hb2KdwfPilqyCYJLXH_sEAKVi/exec';
    const VAPID_PUBLIC_KEY = 'BD09P5I2226LhoIjSPu2uGD81R8lFyte0w6jE2EMUkCW1I0LZC9PYPSkPZxSp0zYyX5zUgUVkRMZHFyCaRYgTkQ';

    // üîî –§–£–ù–ö–¶–ò–Ø –ü–û–î–ü–ò–°–ö–ò –° –†–ê–°–®–ò–†–ï–ù–ù–û–ô –û–¢–õ–ê–î–ö–û–ô
    async function subscribeToPush() {
      console.log('=== –ù–ê–ß–ò–ù–ê–ï–ú –ü–û–î–ü–ò–°–ö–£ ===');
      
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        alert('‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        return false;
      }

      try {
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker
        console.log('üì° –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker...');
        const registration = await navigator.serviceWorker.register('/sw.js');
        await navigator.serviceWorker.ready;
        console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
        console.log('üîê –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...');
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          alert('‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ');
          return false;
        }
        console.log('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ');
        
        // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É
        console.log('üîë –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏...');
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });
        
        console.log('‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞:', subscription);
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const requestData = {
          action: 'saveSubscription',
          user: localStorage.getItem('savedLogin') || 'anonymous',
          subscription: JSON.stringify(subscription)
        };
        
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ URL:', APPS_SCRIPT_URL);
        console.log('üì¶ –î–∞–Ω–Ω—ã–µ:', requestData);
        
        // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê –ë–ï–ó mode: no-cors
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        console.log('‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
        
        if (result.status === 'SAVED') {
          alert('‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
          return true;
        } else {
          throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
        }
      } catch (error) {
        console.error('‚ùå –î–ï–¢–ê–õ–ò –û–®–ò–ë–ö–ò:', error);
        console.error('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
        console.error('‚ùå –°—Ç–µ–∫:', error.stack);
        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏: ' + error.message + '\n–°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π');
        return false;
      }
    }

    // üé≠ –û–ö–ù–û
    function showPushModal() {
      const modal = document.getElementById('push-modal');
      if (modal) modal.style.display = 'flex';
    }

    function hidePushModal() {
      const modal = document.getElementById('push-modal');
      if (modal) modal.style.display = 'none';
    }

    // üîê –û–ë–†–ê–ë–û–¢–ß–ò–ö –§–û–†–ú–´
    document.getElementById('auth-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const login = document.getElementById('login').value;
      const password = document.getElementById('password').value;
      
      try {
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã auth...');
        const response = await fetch('https://script.google.com/macros/s/AKfycbxOGWk-UgU-UO-TByGvusunKeJmhGV--Wmstne1TKlDW1Oq7QZAeR3zEBHhwHAOuA0P/exec', {
          method: 'POST',
          body: new URLSearchParams({ login, password })
        });
        
        const result = await response.text();
        console.log('‚úÖ –û—Ç–≤–µ—Ç auth:', result);
        
        if (result === 'OK') {
          localStorage.setItem('savedLogin', login);
          showPushModal();
        } else {
          alert('–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!');
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ auth:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
      }
    });

    // üéØ –ö–ù–û–ü–ö–ê –ü–û–î–ü–ò–°–ö–ò
    document.getElementById('subscribe-push-btn').addEventListener('click', async (e) => {
      e.preventDefault();
      const btn = e.target;
      btn.disabled = true;
      btn.textContent = '–û–∂–∏–¥–∞–π—Ç–µ...';
      
      const success = await subscribeToPush();
      
      if (success) {
        hidePushModal();
        window.location.href = 'https://sos.emiia.ai/vv1.html?pwa=true';
      } else {
        btn.disabled = false;
        btn.textContent = '–ü–û–õ–£–ß–ê–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø';
      }
    });

    // üîÑ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
    window.addEventListener('DOMContentLoaded', () => {
      const savedLogin = localStorage.getItem('savedLogin');
      if (savedLogin) {
        document.getElementById('login').value = savedLogin;
      }
    });
    </script>

</body>
</html>
