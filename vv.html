<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>–ü–†–û–°–¢–†–ê–ù–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢</title>

<!-- PWA -->
<link rel="shortcut icon" href="/vv.ico" type="image/x-icon">
<meta name="theme-color" content="#f8f9fa">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="/vv.webmanifest">

<!-- –°–æ—Ü—Å–µ—Ç–∏ -->
<meta property="og:type" content="website" />
<meta property="og:url" content="/vv.html" />
<meta property="og:title" content="AI WMS"/>
<meta property="og:image" content="/vvjpg.jpg" />
<meta name="twitter:card" content="summary_large_image" />

<!-- –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê -->
<link rel="preload" href="/telegram-web-app.js" as="script">
<link rel="preload" href="/logo.svg" as="image">

<!-- –°–¢–ò–õ–ò -->
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:monospace;margin:0;padding:0;min-height:100vh;display:flex;justify-content:center;align-items:center;background:#F8F9FA;padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
    .main-container{width:100%;max-width:100%;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .auth-container{background:white;padding:2rem;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.12);width:100%;max-width:400px;margin:0 auto;font-family:monospace}
    h2{color:#da4216;margin:0 0 1.5rem 0;text-align:center;font-size:1.8rem;font-family:monospace}
    .input-group{margin-bottom:1.2rem;font-family:monospace}
    input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;transition:border-color .3s ease;box-sizing:border-box;font-family:monospace;letter-spacing:2px}
    input:focus{outline:none;border-color:#6d9eeb;box-shadow:0 0 0 3px rgba(52,152,219,.1)}
    button{width:100%;padding:14px;background:#6d9eeb;color:white;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:background .3s ease;font-family:monospace;margin-top:.5rem}
    button:hover{background:#3c78d8}
    .text-primary{color:#6d9eeb;text-decoration:none}
    .text-primary1{text-decoration:none;text-align:center;display:block}
    .beta{font-size:.4em}
    img{max-width:100%;height:auto}
    p.small{font-size:.8rem}
    #push-status{margin-top:1rem;padding:10px;border-radius:8px;text-align:center;display:none;font-size:0.9rem}
    #push-status.success{background:#d4edda;color:#155724}
    #push-status.error{background:#f8d7da;color:#721c24}
    #enable-push-btn{display:none;margin-top:1rem;background:#4CAF50;}
    #enable-push-btn:hover{background:#45a049}
    
    @media (max-width:768px){
        .main-container{padding:15px;align-items:flex-start;padding-top:max(20px,env(safe-area-inset-top))}
        .auth-container{padding:1.5rem;margin:0;max-width:100%;width:100%}
        h2{font-size:1.5rem;margin-bottom:1.2rem}
        input{letter-spacing:4.5px;font-size:16px}
        .auth-container{transform:translateZ(0)}
    }
    @media (max-height:600px){
        .main-container{align-items:flex-start;padding-top:10px}
        .auth-container{padding:1.2rem}
    }
    @media (min-width:1024px){
        body{min-height:100vh;overflow:hidden}
        .main-container{min-height:100vh}
    }
</style>
</head>
<body>
    <div class="main-container">
        <div class="auth-container">
            <div class="header-wrapper">
                <h2>
                    <a class="text-primary1" href="https://www.emiia.ru/">
                        <img src="/logo_wms.svg" alt="AI WMS" width="230" height="75" loading="eager">
                    </a>
                </h2>
            </div>

            <div id="update-info"></div>
            <div id="push-status"></div>

            <form id="auth-form">
                <div class="input-group">
                    <input type="text" id="login" name="username" placeholder="Email address" autocomplete="username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" name="password" placeholder="Password" autocomplete="current-password" required>
                </div>
                <p class="small"><a class="text-primary" href="mailto:emiia@emiia.ai">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a></p>

                <button type="submit">–í–û–ô–¢–ò <span>‚ùØ</span></button>
            </form>

            <button id="enable-push-btn">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>

            <p style="margin-top:1rem">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a class="text-primary" href="mailto:emiia@emiia.ai">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
            
            <div style="text-align:center;margin-top:2rem">
                <a class="text-primary1" href="https://www.emiia.ru/" style="color:#da4216;font-weight:600;text-decoration:none">
                    <span style="color:#b2b4b3;font-size:1rem;font-weight:500">–ü–†–û–°–¢–†–ê–ù–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢</span>
                    <span style="font-size:1rem;font-weight:600;color:#3c78d8;margin-left:2px"> ‚Ä¢ ‚ùØ</span>
                </a>
            </div>
        </div>
    </div>

    <!-- –û–¢–õ–û–ñ–ï–ù–ù–´–ï –°–ö–†–ò–ü–¢–´ -->
    <script src="/telegram-web-app.js" async></script>
    
    <script>
    // ==================== PUSH NOTIFICATIONS (–ù–û–í–û–ï) ====================
    const VAPID_PUBLIC_KEY = 'BD09P5I2226LhoIjSPu2uGD81R8lFyte0w6jE2EMUkCW1I0LZC9PYPSkPZxSp0zYyX5zUgUVkRMZHFyCaRYgTkQ';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz0wJrj3cyVhdLZrCtw3u0eO5nqklpEs-lc4vkvyz2hb2KdwfPilqyCYJLXH_sEAKVi/exec';
    let pushRegistration = null;

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => {
                    console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                    pushRegistration = reg;
                })
                .catch(err => console.log('‚ùå SW –æ—à–∏–±–∫–∞:', err));
        });
    }

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    async function subscribeToPush() {
        const statusDiv = document.getElementById('push-status');
        statusDiv.style.display = 'block';
        statusDiv.textContent = '‚è≥ –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...';

        try {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                statusDiv.textContent = '‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã';
                statusDiv.className = 'error';
                return;
            }

            const subscription = await pushRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'saveSubscription',
                    subscription: JSON.stringify(subscription),
                    user: document.getElementById('login').value || 'anonymous'
                })
            });

            const result = await response.text();
            
            if (result.includes('SAVED')) {
                statusDiv.textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!';
                statusDiv.className = 'success';
                document.getElementById('enable-push-btn').style.display = 'none';
            } else {
                throw new Error(result);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
            statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
            statusDiv.className = 'error';
        }
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è VAPID –∫–ª—é—á–∞
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    // ==================== –ö–û–ù–ï–¶ PUSH NOTIFICATIONS ====================

    // TELEGRAM WEBAPP (–í–ê–® –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ö–û–î)
    window.addEventListener('load', () => {
        if (window.Telegram?.WebApp) {
            const tele = window.Telegram.WebApp;
            tele.ready();
            tele.expand();
            tele.SettingsButton.show();
            tele.setHeaderColor("#f8f9fa");
            tele.setBackgroundColor("#f8f9fa");
            tele.enableClosingConfirmation();
            tele.disableVerticalSwipes();
        }
    });

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö –§–û–†–ú–´ (–í–ê–® –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ö–û–î)
    document.getElementById('auth-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const login = document.getElementById('login').value;
        const password = document.getElementById('password').value;
        
        try {
            // ‚úÖ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô fetch —Å URLSearchParams
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({ 
                    action: 'auth',
                    login: login, 
                    password: password 
                })
            });
            
            const result = await response.text();
            
            if (result.includes('OK')) {
                localStorage.setItem('savedLogin', login);
                localStorage.setItem('savedPassword', password);
                
                // ‚úÖ –ü–û–ö–ê–ó–´–í–ê–ï–ú –ö–ù–û–ü–ö–£ PUSH
                document.getElementById('enable-push-btn').style.display = 'block';
                
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
        }
    });

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò PUSH
    document.getElementById('enable-push-btn').addEventListener('click', async () => {
        if (!pushRegistration) {
            alert('‚ùå Service Worker –Ω–µ –≥–æ—Ç–æ–≤, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É');
            return;
        }
        await subscribeToPush();
    });

    // –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï (–í–ê–® –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ö–û–î)
    window.addEventListener('DOMContentLoaded', () => {
        const savedLogin = localStorage.getItem('savedLogin');
        const savedPassword = localStorage.getItem('savedPassword');
        if (savedLogin) document.getElementById('login').value = savedLogin;
        if (savedPassword) document.getElementById('password').value = savedPassword;
    });
    </script>
</body>
</html>
