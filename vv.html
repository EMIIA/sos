<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>–ü–†–û–°–¢–†–ê–ù–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢</title>

<!-- PWA -->
<link rel="shortcut icon" href="/vv.ico" type="image/x-icon">
<meta name="theme-color" content="#f8f9fa">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="/vv.webmanifest">

<!-- –°–¢–ò–õ–ò -->
<style>
    html, body { background-color: #F8F9FA; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:monospace;margin:0;padding:0;min-height:100vh;display:flex;justify-content:center;align-items:center;background:#F8F9FA;padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
    .main-container{width:100%;max-width:100%;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .auth-container{background:white;padding:2rem;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.12);width:100%;max-width:400px;margin:0 auto;font-family:monospace}
    h2{color:#da4216;margin:0 0 1.5rem 0;text-align:center;font-size:1.8rem;font-family:monospace}
    .input-group{margin-bottom:1.2rem;font-family:monospace}
    input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;transition:border-color .3s ease;box-sizing:border-box;font-family:monospace;letter-spacing:2px}
    input:focus{outline:none;border-color:#6d9eeb;box-shadow:0 0 0 3px rgba(52,152,219,.1)}
    button{width:100%;padding:14px;background:#6d9eeb;color:white;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:background .3s ease;font-family:monospace;margin-top:.5rem}
    button:hover{background:#3c78d8}
    .text-primary{color:#6d9eeb;text-decoration:none}
    .text-primary1{text-decoration:none;text-align:center;display:block}
    .beta{font-size:.4em}
    img{max-width:100%;height:auto}
    p.small{font-size:.8rem}
    #push-status{margin-top:1rem;padding:10px;border-radius:8px;text-align:center;display:none;font-size:0.9rem}
    #push-status.success{background:#d4edda;color:#155724}
    #push-status.error{background:#f8d7da;color:#721c24}
    #enable-push-btn{display:none;margin-top:1rem;background:#4CAF50;}
    #enable-push-btn:hover{background:#45a049}
    .debug-info{display:none;margin-top:1rem;font-size:0.8rem;color:#666;font-family:monospace}
</style>
</head>
<body>
    <div class="main-container">
        <div class="auth-container">
            <div class="header-wrapper">
                <h2>
                    <a class="text-primary1" href="https://www.emiia.ru/">
                        <img src="/logo_wms.svg" alt="AI WMS" width="230" height="75" loading="eager">
                    </a>
                </h2>
            </div>

            <div id="update-info"></div>
            <div id="push-status"></div>

            <form id="auth-form">
                <div class="input-group">
                    <input type="text" id="login" name="username" placeholder="Email address" autocomplete="username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" name="password" placeholder="Password" autocomplete="current-password" required>
                </div>
                <p class="small"><a class="text-primary" href="mailto:emiia@emiia.ai">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a></p>

                <button type="submit">–í–û–ô–¢–ò <span>‚ùØ</span></button>
            </form>

            <button id="enable-push-btn">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>

            <p style="margin-top:1rem">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a class="text-primary" href="mailto:emiia@emiia.ai">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
            
            <div style="text-align:center;margin-top:2rem">
                <a class="text-primary1" href="https://www.emiia.ru/" style="color:#da4216;font-weight:600;text-decoration:none">
                    <span style="color:#b2b4b3;font-size:1rem;font-weight:500">–ü–†–û–°–¢–†–ê–ù–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢</span>
                    <span style="font-size:1rem;font-weight:600;color:#3c78d8;margin-left:2px"> ‚Ä¢ ‚ùØ</span>
                </a>
            </div>
        </div>
    </div>

    <!-- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï -->
    <script>
    let pushRegistration = null;
    const VAPID_PUBLIC_KEY = 'BD09P5I2226LhoIjSPu2uGD81R8lFyte0w6jE2EMUkCW1I0LZC9PYPSkPZxSp0zYyX5zUgUVkRMZHFyCaRYgTkQ';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz0wJrj3cyVhdLZrCtw3u0eO5nqklpEs-lc4vkvyz2hb2KdwfPilqyCYJLXH_sEAKVi/exec';
    </script>

    <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø SERVICE WORKER -->
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
                    pushRegistration = registration;
                })
                .catch(error => console.log('‚ùå SW –æ—à–∏–±–∫–∞:', error));
        });
    }
    </script>

    <!-- –õ–û–ì–ò–ö–ê PUSH-–£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
    <script>
    async function subscribeToPush() {
        const statusDiv = document.getElementById('push-status');
        statusDiv.style.display = 'block';
        statusDiv.textContent = '‚è≥ –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...';
        
        console.log('üöÄ –ù–∞—á–∞–ª–æ –ø–æ–¥–ø–∏—Å–∫–∏...');

        if (!pushRegistration) {
            statusDiv.textContent = '‚ùå SW –Ω–µ –≥–æ—Ç–æ–≤, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É';
            statusDiv.className = 'error';
            console.error('pushRegistration = null');
            return;
        }

        try {
            console.log('üìã –ó–∞–ø—Ä–∞—à–∏–≤–∞—é permission...');
            const permission = await Notification.requestPermission();
            console.log('üìã Permission:', permission);

            if (permission !== 'granted') {
                statusDiv.textContent = '‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ! –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                statusDiv.className = 'error';
                return;
            }

            console.log('üìã –ü–æ–¥–ø–∏—Å—ã–≤–∞—é—Å—å –Ω–∞ push...');
            const subscription = await pushRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });

            console.log('üìã –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞:', subscription);

            console.log('üìã –û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                credentials: 'omit', // ‚úÖ –í–ê–ñ–ù–û: –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å cookies
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'saveSubscription',
                    subscription: JSON.stringify(subscription),
                    user: document.getElementById('login').value || 'anonymous',
                    userAgent: navigator.userAgent
                })
            });

            console.log('üìã –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
            const result = await response.text();
            console.log('üìã –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞:', result);

            if (result.includes('SAVED')) {
                statusDiv.textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!';
                statusDiv.className = 'success';
                document.getElementById('enable-push-btn').style.display = 'none';
            } else {
                throw new Error('–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª: ' + result);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
            statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
            statusDiv.className = 'error';
        }
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    </script>

    <!-- TELEGRAM WEBAPP -->
    <script src="/telegram-web-app.js" async></script>
    <script>
    window.addEventListener('load', () => {
        if (window.Telegram?.WebApp) {
            const tele = window.Telegram.WebApp;
            tele.ready();
            tele.expand();
            tele.SettingsButton.show();
            tele.setHeaderColor("#f8f9fa");
            tele.setBackgroundColor("#f8f9fa");
            tele.enableClosingConfirmation();
            tele.disableVerticalSwipes();
        }
    });
    </script>

    <!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï UI -->
    <script>
    document.getElementById('auth-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const login = document.getElementById('login').value;
        const password = document.getElementById('password').value;
        
        try {
            console.log('üîê –û—Ç–ø—Ä–∞–≤–ª—è—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                credentials: 'omit', // ‚úÖ –í–ê–ñ–ù–û
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    action: 'auth',
                    login: login,
                    password: password
                })
            });
            
            const result = await response.text();
            console.log('üìã –û—Ç–≤–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', result);

            if (result.includes('OK')) {
                localStorage.setItem('savedLogin', login);
                localStorage.setItem('savedPassword', password);
                document.getElementById('enable-push-btn').style.display = 'block';
                
                // –û–ß–ò–©–ê–ï–ú –°–¢–ê–¢–£–°
                document.getElementById('push-status').style.display = 'none';
                document.getElementById('push-status').textContent = '';
                
                alert('‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"');
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
        }
    });

    document.getElementById('enable-push-btn').addEventListener('click', async () => {
        await subscribeToPush();
    });

    window.addEventListener('DOMContentLoaded', () => {
        const savedLogin = localStorage.getItem('savedLogin');
        const savedPassword = localStorage.getItem('savedPassword');
        if (savedLogin) document.getElementById('login').value = savedLogin;
        if (savedPassword) document.getElementById('password').value = savedPassword;
    });

    // –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò
    window.addEventListener('load', () => {
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏...');
        console.log('Service Worker:', 'serviceWorker' in navigator);
        console.log('PushManager:', 'PushManager' in window);
        console.log('Notifications:', 'Notification' in window);
    });
    </script>
</body>
</html>
