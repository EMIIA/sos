<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMIIA.AI</title>
<link rel="manifest" href="/vv.webmanifest">
</head>
<body style="font-family:monospace; padding:20px;">

  <h1>Вход</h1>
  <input id="login" placeholder="Email" style="width:100%; padding:10px; margin:10px 0;">
  <input id="password" type="password" placeholder="Password" style="width:100%; padding:10px; margin:10px 0;">
  <button onclick="login()" style="width:100%; padding:10px;">ВОЙТИ</button>
  
  <button onclick="subscribeToPush()" style="width:100%; padding:10px; margin-top:20px;">ПОДПИСАТЬСЯ</button>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz0wJrj3cyVhdLZrCtw3u0eO5nqklpEs-lc4vkvyz2hb2KdwfPilqyCYJLXH_sEAKVi/exec';
    const VAPID_PUBLIC_KEY = 'BD09P5I2226LhoIjSPu2uGD81R8lFyte0w6jE2EMUkCW1I0LZC9PYPSkPZxSp0zYyX5zUgUVkRMZHFyCaRYgTkQ';

    async function login() {
      localStorage.setItem('savedLogin', document.getElementById('login').value);
      alert('Вход выполнен, теперь подпишитесь');
    }

    async function subscribeToPush() {
      console.log('=== START SUBSCRIBE ===');
      
      const registration = await navigator.serviceWorker.register('/sw.js');
      await navigator.serviceWorker.ready;
      
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
      });
      
      console.log('Sub created:', subscription);

      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          action: 'saveSubscription',
          user: localStorage.getItem('savedLogin') || 'anonymous',
          subscription: JSON.stringify(subscription)
        })
      });
      
      const result = await response.json();
      console.log('Server response:', result);
      alert(result.status === 'SAVED' ? '✅ Успешно!' : '❌ Ошибка');
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
  </script>

</body>
</html>
