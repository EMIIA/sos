<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset='utf-8' />
    <title>EMIIA.AI MRV - –†–µ–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#007cbf"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest_wifi.json">
    
    <!-- Mapbox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        
        .controls-panel {
            position: absolute; top: 20px; left: 20px; background: white; padding: 20px;
            border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); width: 400px;
            max-height: 90vh; overflow-y: auto; z-index: 1000;
        }
        
        .panel-header { display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e8ecef; }
        .panel-header h1 { font-size: 1.3em; color: #2c3e50; margin-left: 10px; }
        .icon { font-size: 1.8em; }
        
        .section { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #3498db; }
        .section-title { font-size: 1.1em; font-weight: 600; color: #2c3e50; margin-bottom: 12px; display: flex; align-items: center; }
        .section-title .icon { margin-right: 8px; font-size: 1.2em; }
        
        .coord-display { background: white; padding: 10px; border-radius: 8px; border: 1px solid #e1e8ed; margin-bottom: 8px; font-family: monospace; font-size: 0.8em; }
        .coord-label { font-weight: 600; color: #7f8c8d; font-size: 0.75em; text-transform: uppercase; }
        .coord-value { color: #2c3e50; word-break: break-all; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: #007cbf; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .status-indicator { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 0.9em; font-weight: 500; }
        .status-online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-scanning { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .network-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .info-item { background: white; padding: 8px; border-radius: 6px; border: 1px solid #e1e8ed; }
        .info-label { font-size: 0.7em; color: #7f8c8d; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .info-value { font-size: 0.8em; color: #2c3e50; font-weight: 500; font-family: monospace; }
        
        .accuracy-display { text-align: center; padding: 12px; background: #007cbf; color: white; border-radius: 8px; margin-top: 8px; }
        .accuracy-value { font-size: 1.8em; font-weight: 700; margin: 3px 0; }
        .accuracy-label { font-size: 0.8em; opacity: 0.9; }
        
        .hidden { display: none; }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .controls-panel { 
                width: calc(100% - 40px); 
                left: 20px; 
                right: 20px;
                padding: 15px;
            }
            .btn-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="controls-panel">
        <div class="panel-header">
            <div class="icon">üì°</div>
            <h1>EMIIA.AI MRV - –†–µ–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        </div>

        <div class="status-indicator" id="systemStatus">
            <div class="icon">‚è≥</div>
            <span>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...</span>
        </div>

        <div class="section">
            <div class="section-title">
                <div class="icon">üåê</div>
                Wi-Fi —Å–µ—Ç—å
            </div>
            <div class="network-info-grid">
                <div class="info-item"><div class="info-label">SSID</div><div class="info-value">EMIIA.AI MRV</div></div>
                <div class="info-item"><div class="info-label">MAC</div><div class="info-value">28-CD-C4-13-EE-A3</div></div>
                <div class="info-item"><div class="info-label">–°–∏–≥–Ω–∞–ª</div><div class="info-value" id="signalValue">- dBm</div></div>
                <div class="info-item"><div class="info-label">–°—Ç–∞—Ç—É—Å</div><div class="info-value" id="wifiStatus">–û–∂–∏–¥–∞–Ω–∏–µ</div></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                <div class="icon">üìç</div>
                –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            </div>
            <div class="coord-display">
                <div class="coord-label">–†–æ—É—Ç–µ—Ä (–®–∏—Ä–æ—Ç–∞)</div>
                <div class="coord-value" id="routerLat">55.98346937</div>
            </div>
            <div class="coord-display">
                <div class="coord-label">–†–æ—É—Ç–µ—Ä (–î–æ–ª–≥–æ—Ç–∞)</div>
                <div class="coord-value" id="routerLng">37.16332212</div>
            </div>
            <div class="coord-display">
                <div class="coord-label">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–®–∏—Ä–æ—Ç–∞)</div>
                <div class="coord-value" id="currentLat">-</div>
            </div>
            <div class="coord-display">
                <div class="coord-label">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–î–æ–ª–≥–æ—Ç–∞)</div>
                <div class="coord-value" id="currentLng">-</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                <div class="icon">üéØ</div>
                –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            </div>
            <div class="accuracy-display">
                <div class="accuracy-value" id="accuracyValue">-</div>
                <div class="accuracy-label">–º–µ—Ç—Ä–æ–≤</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                <div class="icon">‚öôÔ∏è</div>
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="startRealGeolocation()" id="startBtn">
                    <div class="icon">üöÄ</div>
                    –ó–∞–ø—É—Å–∫
                </button>
                <button class="btn btn-secondary" onclick="stopPositioning()" id="stopBtn" disabled>
                    <div class="icon">‚èπÔ∏è</div>
                    –°—Ç–æ–ø
                </button>
                <button class="btn btn-success" onclick="testWiFiAPI()" id="wifiBtn">
                    <div class="icon">üì∂</div>
                    –¢–µ—Å—Ç Wi-Fi API
                </button>
                <button class="btn btn-warning" onclick="showDebugInfo()">
                    <div class="icon">üêõ</div>
                    –û—Ç–ª–∞–¥–∫–∞
                </button>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                <div class="icon">üìä</div>
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </div>
            <div class="network-info-grid">
                <div class="info-item"><div class="info-label">–û–±–Ω–æ–≤–ª–µ–Ω–∏–π</div><div class="info-value" id="updateCount">0</div></div>
                <div class="info-item"><div class="info-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div><div class="info-value" id="distanceValue">- –º</div></div>
                <div class="info-item"><div class="info-label">–ú–µ—Ç–æ–¥</div><div class="info-value" id="methodValue">-</div></div>
                <div class="info-item"><div class="info-label">–í–µ—Ä—Å–∏—è</div><div class="info-value">Chrome + —Ñ–ª–∞–≥–∏</div></div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –æ—Ç–ª–∞–¥–∫–∏ -->
        <div class="section hidden" id="debugSection">
            <div class="section-title">
                <div class="icon">üêõ</div>
                –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            </div>
            <div id="debugInfo" style="font-size: 0.7em; font-family: monospace; max-height: 200px; overflow-y: auto;">
                <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
        const PRECISE_ROUTER_POSITION = [37.16332212, 55.98346937];
        const PRECISE_ROOM_CORNERS = [
            [37.16344674, 55.98346609],
            [37.16332363, 55.98346489],  
            [37.16330701, 55.98350694],
            [37.16344154, 55.98350823],
            [37.16344674, 55.98346609]
        ];

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let isPositioningActive = false;
        let watchId = null;
        let updateCount = 0;

        // Mapbox —Ç–æ–∫–µ–Ω
        mapboxgl.accessToken = 'pk.eyJ1Ijoia211bm96IiwiYSI6ImNsY3A3NDloaDA2bnozcGxiN2U1Y2I2bWIifQ.WY4_mVStBm5c9CjvWsVy3w';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
        async function initializeSystem() {
            try {
                // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
                if ('serviceWorker' in navigator) {
                    await navigator.serviceWorker.register('/sw_wifi.js');
                    addDebugInfo('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
                await initializeMap();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö API
                await checkAvailableAPIs();
                
                updateSystemStatus('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'status-online');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                updateSystemStatus('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'status-offline');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö API
        async function checkAvailableAPIs() {
            addDebugInfo('=== –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–´–• API ===');
            
            // 1. –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
            if ('geolocation' in navigator) {
                addDebugInfo('‚úÖ navigator.geolocation - –î–û–°–¢–£–ü–ï–ù');
            } else {
                addDebugInfo('‚ùå navigator.geolocation - –ù–ï–î–û–°–¢–£–ü–ï–ù');
            }

            // 2. Wi-Fi API (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π)
            if ('wifi' in navigator) {
                addDebugInfo('‚úÖ navigator.wifi - –î–û–°–¢–£–ü–ï–ù (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π)');
            } else {
                addDebugInfo('‚ùå navigator.wifi - –ù–ï–î–û–°–¢–£–ü–ï–ù');
            }

            // 3. Network Information API
            if ('connection' in navigator) {
                addDebugInfo('‚úÖ navigator.connection - –î–û–°–¢–£–ü–ï–ù');
                const conn = navigator.connection;
                addDebugInfo(`   –¢–∏–ø: ${conn.effectiveType}, –°–∫–æ—Ä–æ—Å—Ç—å: ${conn.downlink} Mbps`);
            } else {
                addDebugInfo('‚ùå navigator.connection - –ù–ï–î–û–°–¢–£–ü–ï–ù');
            }

            // 4. Permissions API
            if ('permissions' in navigator) {
                addDebugInfo('‚úÖ navigator.permissions - –î–û–°–¢–£–ü–ï–ù');
            } else {
                addDebugInfo('‚ùå navigator.permissions - –ù–ï–î–û–°–¢–£–ü–ï–ù');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initializeMap() {
            return new Promise((resolve) => {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/satellite-v9',
                    center: PRECISE_ROUTER_POSITION,
                    zoom: 20,
                    pitch: 45
                });

                map.addControl(new mapboxgl.NavigationControl());
                map.addControl(new mapboxgl.ScaleControl());

                map.on('load', () => {
                    setupRoomVisualization();
                    addRouterMarker();
                    resolve();
                });
            });
        }

        function setupRoomVisualization() {
            // –ü–æ–ª–∏–≥–æ–Ω –∫–æ–º–Ω–∞—Ç—ã
            map.addSource('room', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: {
                        type: 'Polygon',
                        coordinates: [PRECISE_ROOM_CORNERS]
                    }
                }
            });

            map.addLayer({
                id: 'room-fill',
                type: 'fill',
                source: 'room',
                paint: {
                    'fill-color': '#007cbf',
                    'fill-opacity': 0.1
                }
            });

            map.addLayer({
                id: 'room-border',
                type: 'line',
                source: 'room',
                paint: {
                    'line-color': '#007cbf',
                    'line-width': 3
                }
            });
        }

        function addRouterMarker() {
            new mapboxgl.Marker({
                color: '#dc3545',
                scale: 1.3
            })
            .setLngLat(PRECISE_ROUTER_POSITION)
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML(`
                    <div style="padding: 10px;">
                        <h3 style="margin: 0 0 8px 0; color: #dc3545;">üì° EMIIA.AI MRV</h3>
                        <div style="font-size: 11px; font-family: monospace;">
                            <div>MAC: 28-CD-C4-13-EE-A3</div>
                            <div>–®: ${PRECISE_ROUTER_POSITION[1].toFixed(8)}</div>
                            <div>–î: ${PRECISE_ROUTER_POSITION[0].toFixed(8)}</div>
                        </div>
                    </div>
                `)
            )
            .addTo(map);

            document.getElementById('routerLat').textContent = PRECISE_ROUTER_POSITION[1].toFixed(8);
            document.getElementById('routerLng').textContent = PRECISE_ROUTER_POSITION[0].toFixed(8);
        }

        // –†–ï–ê–õ–¨–ù–ê–Ø –ì–ï–û–õ–û–ö–ê–¶–ò–Ø —á–µ—Ä–µ–∑ navigator.geolocation
        async function startRealGeolocation() {
            if (isPositioningActive) return;
            
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
            try {
                const permission = await navigator.permissions.query({ name: 'geolocation' });
                addDebugInfo(`–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ${permission.state}`);
                
                if (permission.state === 'denied') {
                    alert('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                    return;
                }
            } catch (error) {
                addDebugInfo('Permissions API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');
            }

            isPositioningActive = true;
            updateSystemStatus('üìç –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...', 'status-scanning');
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º watchPosition –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            watchId = navigator.geolocation.watchPosition(
                // –£—Å–ø–µ—à–Ω—ã–π callback
                (position) => {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    const accuracy = position.coords.accuracy;
                    
                    updateCount++;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    let method = 'GPS';
                    if (accuracy > 100) method = '–°–µ—Ç—å (Wi-Fi/–°–æ—Ç–æ–≤–∞—è)';
                    else if (accuracy <= 20) method = '–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (GPS+Wi-Fi)';
                    
                    updatePositionDisplay(coords, accuracy, method);
                    updateStatistics(coords, accuracy, method);
                    
                    updateSystemStatus('‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã', 'status-online');
                    addDebugInfo(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${updateCount}: ${coords[1].toFixed(6)}, ${coords[0].toFixed(6)} (—Ç–æ—á–Ω–æ—Å—Ç—å: ${accuracy}m)`);
                },
                // –û—à–∏–±–∫–∞
                (error) => {
                    let errorMessage = '–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '‚ùå –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '‚ùå –î–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '‚è∞ –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏';
                            break;
                        default:
                            errorMessage = '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏';
                    }
                    updateSystemStatus(errorMessage, 'status-offline');
                    addDebugInfo(`–û–®–ò–ë–ö–ê: ${errorMessage}`);
                },
                // –û–ø—Ü–∏–∏ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å)
                {
                    enableHighAccuracy: true,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º Wi-Fi –∏ GPS
                    timeout: 10000,           // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                    maximumAge: 0             // –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                }
            );
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Wi-Fi API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        async function testWiFiAPI() {
            addDebugInfo('=== –¢–ï–°–¢ WI-FI API ===');
            
            if ('wifi' in navigator) {
                try {
                    updateSystemStatus('üì∂ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Wi-Fi...', 'status-scanning');
                    
                    const networks = await navigator.wifi.getNetworks();
                    addDebugInfo(`‚úÖ –ù–∞–π–¥–µ–Ω–æ Wi-Fi —Å–µ—Ç–µ–π: ${networks.length}`);
                    
                    networks.forEach((network, index) => {
                        addDebugInfo(`   –°–µ—Ç—å ${index + 1}: ${network.ssid || '–°–∫—Ä—ã—Ç–∞—è'} (${network.signalStrength || 'N/A'} dBm)`);
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏–≥–Ω–∞–ª–µ
                    if (networks.length > 0) {
                        const myNetwork = networks.find(n => n.ssid === 'EMIIA.AI MRV') || networks[0];
                        document.getElementById('signalValue').textContent = 
                            (myNetwork.signalStrength || -50) + ' dBm';
                        document.getElementById('wifiStatus').textContent = '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞';
                    }
                    
                    updateSystemStatus('‚úÖ Wi-Fi —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'status-online');
                    
                } catch (error) {
                    addDebugInfo(`‚ùå –û—à–∏–±–∫–∞ Wi-Fi API: ${error.message}`);
                    updateSystemStatus('‚ùå –û—à–∏–±–∫–∞ Wi-Fi —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'status-offline');
                }
            } else {
                addDebugInfo('‚ùå Wi-Fi API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                updateSystemStatus('‚ùå Wi-Fi API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'status-offline');
            }
        }

        function updatePositionDisplay(coords, accuracy, method) {
            document.getElementById('currentLat').textContent = coords[1].toFixed(8);
            document.getElementById('currentLng').textContent = coords[0].toFixed(8);
            document.getElementById('accuracyValue').textContent = accuracy.toFixed(1);
            document.getElementById('methodValue').textContent = method;

            updatePositionMarker(coords, accuracy);
        }

        function updatePositionMarker(coords, accuracy) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
            if (window.positionMarker) {
                window.positionMarker.remove();
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
            window.positionMarker = new mapboxgl.Marker({
                color: '#28a745',
                scale: 1.2
            })
            .setLngLat(coords)
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML(`
                    <div style="padding: 10px;">
                        <h4 style="margin: 0 0 6px 0; color: #28a745;">üìç –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è</h4>
                        <div style="font-size: 11px; font-family: monospace;">
                            <div>–®: ${coords[1].toFixed(8)}</div>
                            <div>–î: ${coords[0].toFixed(8)}</div>
                            <div>–¢–æ—á–Ω–æ—Å—Ç—å: ¬±${accuracy.toFixed(1)}–º</div>
                            <div>–û–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${updateCount}</div>
                        </div>
                    </div>
                `)
            )
            .addTo(map);

            // –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
            map.flyTo({
                center: coords,
                zoom: 20,
                speed: 0.3,
                essential: true
            });
        }

        function updateStatistics(coords, accuracy, method) {
            const distance = calculateDistance(coords, PRECISE_ROUTER_POSITION);
            document.getElementById('distanceValue').textContent = distance.toFixed(2) + ' –º';
            document.getElementById('updateCount').textContent = updateCount;
        }

        function calculateDistance(point1, point2) {
            const R = 6371000;
            const dLat = (point2[1] - point1[1]) * Math.PI / 180;
            const dLon = (point2[0] - point1[0]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(point1[1] * Math.PI / 180) * Math.cos(point2[1] * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function stopPositioning() {
            isPositioningActive = false;
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            updateSystemStatus('‚è∏Ô∏è –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'status-offline');
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function showDebugInfo() {
            const debugSection = document.getElementById('debugSection');
            debugSection.classList.toggle('hidden');
        }

        function addDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${message}<br>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        function updateSystemStatus(message, className) {
            const statusElement = document.getElementById('systemStatus');
            const icon = className.includes('online') ? '‚úÖ' : 
                        className.includes('scanning') ? 'üîç' : '‚è∏Ô∏è';
            statusElement.innerHTML = `<div class="icon">${icon}</div><span>${message}</span>`;
            statusElement.className = `status-indicator ${className}`;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initializeSystem);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.startRealGeolocation = startRealGeolocation;
        window.stopPositioning = stopPositioning;
        window.testWiFiAPI = testWiFiAPI;
        window.showDebugInfo = showDebugInfo;
    </script>
</body>
</html>
