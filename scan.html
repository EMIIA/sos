<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset='utf-8' />
    <title>–¢–æ—á–Ω–æ–µ Wi-Fi –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - EMIIA.AI MRV</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    
    <!-- Mapbox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8ecef;
        }

        .panel-header h1 {
            font-size: 1.3em;
            color: #2c3e50;
            margin-left: 10px;
        }

        .icon {
            font-size: 1.8em;
        }

        /* –°–µ–∫—Ü–∏–∏ */
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .section-title .icon {
            margin-right: 8px;
            font-size: 1.2em;
        }

        /* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã */
        .coord-display {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            margin-bottom: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8em;
            line-height: 1.4;
        }

        .coord-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .coord-value {
            color: #2c3e50;
            word-break: break-all;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* –°—Ç–∞—Ç—É—Å */
        .status-indicator {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-scanning {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏ */
        .network-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .info-item {
            background: white;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e1e8ed;
        }

        .info-label {
            font-size: 0.7em;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 0.8em;
            color: #2c3e50;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        /* –¢–æ—á–Ω–æ—Å—Ç—å */
        .accuracy-display {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-top: 8px;
        }

        .accuracy-value {
            font-size: 1.8em;
            font-weight: 700;
            margin: 3px 0;
        }

        .accuracy-label {
            font-size: 0.8em;
            opacity: 0.9;
        }

        /* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .hidden {
            display: none;
        }

        /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .controls-panel {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="controls-panel">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="panel-header">
            <div class="icon">üì°</div>
            <h1>EMIIA.AI MRV - –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
        <div class="status-indicator" id="systemStatus">
            <div class="icon">‚è≥</div>
            <span>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...</span>
        </div>

        <!-- –°–µ–∫—Ü–∏—è: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">üåê</div>
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏
            </div>
            <div class="network-info-grid">
                <div class="info-item">
                    <div class="info-label">SSID</div>
                    <div class="info-value">EMIIA.AI MRV</div>
                </div>
                <div class="info-item">
                    <div class="info-label">MAC</div>
                    <div class="info-value">28-CD-C4-13-EE-A3</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ü—Ä–æ—Ç–æ–∫–æ–ª</div>
                    <div class="info-value">Wi-Fi 4 (802.11n)</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ö–∞–Ω–∞–ª</div>
                    <div class="info-value">9 (2.4 –ì–ì—Ü)</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–°–∫–æ—Ä–æ—Å—Ç—å</div>
                    <div class="info-value">300/300 Mbps</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
                    <div class="info-value">WPA2-Personal</div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–æ—É—Ç–µ—Ä–∞ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">üìç</div>
                –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–æ—É—Ç–µ—Ä–∞
            </div>
            <div class="coord-display">
                <div class="coord-label">–®–∏—Ä–æ—Ç–∞</div>
                <div class="coord-value" id="routerLat">55.98346937</div>
            </div>
            <div class="coord-display">
                <div class="coord-label">–î–æ–ª–≥–æ—Ç–∞</div>
                <div class="coord-value" id="routerLng">37.16332212</div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è: –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è -->
        <div class="section">
            <div class="section-title">
                <div class="icon">üéØ</div>
                –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è
            </div>
            <div class="coord-display">
                <div class="coord-label">–®–∏—Ä–æ—Ç–∞</div>
                <div class="coord-value" id="currentLat">-</div>
            </div>
            <div class="coord-display">
                <div class="coord-label">–î–æ–ª–≥–æ—Ç–∞</div>
                <div class="coord-value" id="currentLng">-</div>
            </div>
            
            <div class="accuracy-display">
                <div class="accuracy-label">–¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                <div class="accuracy-value" id="accuracyValue">-</div>
                <div class="accuracy-label">–º–µ—Ç—Ä–æ–≤</div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">‚öôÔ∏è</div>
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="startPositioning()" id="startBtn">
                    <div class="icon">üöÄ</div>
                    –°—Ç–∞—Ä—Ç
                </button>
                <button class="btn btn-secondary" onclick="stopPositioning()" id="stopBtn" disabled>
                    <div class="icon">‚èπÔ∏è</div>
                    –°—Ç–æ–ø
                </button>
                <button class="btn btn-success" onclick="calibrateSystem()" id="calibrateBtn">
                    <div class="icon">üéöÔ∏è</div>
                    –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞
                </button>
                <button class="btn btn-warning" onclick="toggleTrainingMode()" id="trainingBtn">
                    <div class="icon">üéì</div>
                    –û–±—É—á–µ–Ω–∏–µ
                </button>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">üìä</div>
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </div>
            <div class="network-info-grid">
                <div class="info-item">
                    <div class="info-label">–û–±–Ω–æ–≤–ª–µ–Ω–∏–π</div>
                    <div class="info-value" id="updateCount">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                    <div class="info-value" id="confidenceValue">0%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">RSSI</div>
                    <div class="info-value" id="rssiValue">- dBm</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                    <div class="info-value" id="distanceValue">- –º</div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div class="section hidden" id="trainingSection">
            <div class="section-title">
                <div class="icon">üéì</div>
                –†–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è
            </div>
            <div style="margin-bottom: 12px;">
                <input type="text" id="pointName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –æ–±—É—á–µ–Ω–∏—è" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 8px; font-size: 0.85em;">
                <button class="btn btn-success" onclick="addTrainingPoint()" style="width: 100%;">
                    <div class="icon">‚ûï</div>
                    –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç–æ—á–∫—É
                </button>
            </div>
            <div id="trainingPointsList" style="max-height: 120px; overflow-y: auto; font-size: 0.8em;">
                <!-- –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –æ–±—É—á–µ–Ω–∏—è –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <script>
        // –¢–û–ß–ù–´–ï –ö–û–û–†–î–ò–ù–ê–¢–´ –° –í–ê–®–ò–ú–ò –î–ê–ù–ù–´–ú–ò
        const PRECISE_ROUTER_POSITION = [37.16332212, 55.98346937];
        const PRECISE_ROOM_CORNERS = [
            [37.16344674, 55.98346609],
            [37.16332363, 55.98346489],  
            [37.16330701, 55.98350694],
            [37.16344154, 55.98350823],
            [37.16344674, 55.98346609]
        ];

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—à–µ–π Wi-Fi —Å–µ—Ç–∏
        const WIFI_CONFIG = {
            ssid: "EMIIA.AI MRV",
            mac: "28-CD-C4-13-EE-A3",
            protocol: "Wi-Fi 4 (802.11n)",
            security: "WPA2-Personal",
            frequency: 2.4, // GHz
            channel: 9,
            maxSpeed: 300, // Mbps
            ipv4: "192.168.1.52",
            routerIp: "192.168.1.1",
            manufacturer: "Realtek Semiconductor Corp.",
            model: "Realtek 8822CE Wireless LAN 802.11ac PCI-E NIC",
            driverVersion: "2024.0.9.230"
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let positioningSystem;
        let isPositioningActive = false;
        let positioningInterval;
        let updateCount = 0;
        let trainingMode = false;
        let currentRSSI = -45;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mapbox
        mapboxgl.accessToken = 'pk.eyJ1Ijoia211bm96IiwiYSI6ImNsY3A3NDloaDA2bnozcGxiN2U1Y2I2bWIifQ.WY4_mVStBm5c9CjvWsVy3w';

        function initializeMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-v9',
                center: PRECISE_ROUTER_POSITION,
                zoom: 20,
                pitch: 60,
                bearing: 0
            });

            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.ScaleControl());

            map.on('load', () => {
                initializePositioningSystem();
                setupRoomVisualization();
                addRouterMarker();
                updateSystemStatus('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'status-online');
                calculateRoomDimensions();
            });
        }

        function calculateRoomDimensions() {
            const width = calculateDistance(PRECISE_ROOM_CORNERS[0], PRECISE_ROOM_CORNERS[1]);
            const height = calculateDistance(PRECISE_ROOM_CORNERS[1], PRECISE_ROOM_CORNERS[2]);
            
            console.log(`–†–∞–∑–º–µ—Ä—ã –∫–æ–º–Ω–∞—Ç—ã: ${width.toFixed(2)}–º x ${height.toFixed(2)}–º`);
            showNotification(`–ö–æ–º–Ω–∞—Ç–∞: ${width.toFixed(1)}√ó${height.toFixed(1)}–º`, 'info');
        }

        function calculateDistance(point1, point2) {
            const R = 6371000;
            const dLat = (point2[1] - point1[1]) * Math.PI / 180;
            const dLon = (point2[0] - point1[0]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(point1[1] * Math.PI / 180) * Math.cos(point2[1] * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function initializePositioningSystem() {
            positioningSystem = {
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ Wi-Fi
                estimatePosition: (rssi) => {
                    const distance = this.calculateDistanceFromRSSI(rssi);
                    const angle = Math.random() * 2 * Math.PI;
                    
                    // –†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ —É–≥–ª–∞ –æ—Ç —Ä–æ—É—Ç–µ—Ä–∞
                    const offsetLng = (distance * Math.cos(angle)) / (111320 * Math.cos(PRECISE_ROUTER_POSITION[1] * Math.PI / 180));
                    const offsetLat = (distance * Math.sin(angle)) / 111320;
                    
                    let position = [
                        PRECISE_ROUTER_POSITION[0] + offsetLng,
                        PRECISE_ROUTER_POSITION[1] + offsetLat
                    ];
                    
                    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã—à–ª–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–æ–º–Ω–∞—Ç—ã
                    if (!isPointInPolygon(position, PRECISE_ROOM_CORNERS)) {
                        position = getAdjustedPosition(position, distance);
                    }
                    
                    const accuracy = this.calculateAccuracy(rssi, distance);
                    const confidence = this.calculateConfidence(rssi);
                    
                    return {
                        point: position,
                        accuracy: accuracy,
                        confidence: confidence,
                        distance: distance,
                        rssi: rssi
                    };
                },

                calculateDistanceFromRSSI: (rssi) => {
                    // –ú–æ–¥–µ–ª—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞ –¥–ª—è 2.4 –ì–ì—Ü
                    const freq = 2400; // MHz
                    const txPower = 20; // dBm (—Ç–∏–ø–∏—á–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏)
                    const pathLossExponent = 2.5; // –î–ª—è –ø–æ–º–µ—â–µ–Ω–∏–π
                    
                    // –§–æ—Ä–º—É–ª–∞ –ø–æ—Ç–µ—Ä—å –Ω–∞ –ø—É—Ç–∏
                    const distance = Math.pow(10, (txPower - rssi) / (10 * pathLossExponent));
                    return Math.max(0.1, Math.min(10, distance)); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—É–º–Ω—ã–º–∏ –ø—Ä–µ–¥–µ–ª–∞–º–∏
                },

                calculateAccuracy: (rssi, distance) => {
                    // –¢–æ—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∏–ª—ã —Å–∏–≥–Ω–∞–ª–∞ –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                    const baseAccuracy = 0.5;
                    const rssiFactor = Math.max(0, (-rssi - 40) / 40); // –û—Ç -40 –¥–æ -80 dBm
                    const distanceFactor = distance / 5;
                    
                    return baseAccuracy + rssiFactor + distanceFactor;
                },

                calculateConfidence: (rssi) => {
                    // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Å–∏–≥–Ω–∞–ª–∞
                    const minRSSI = -80;
                    const maxRSSI = -30;
                    const normalized = (rssi - minRSSI) / (maxRSSI - minRSSI);
                    return Math.max(0.3, Math.min(0.95, normalized));
                }
            };
        }

        function calculateDistanceFromRSSI(rssi) {
            const txPower = 20; // dBm
            const pathLossExponent = 2.5;
            const distance = Math.pow(10, (txPower - rssi) / (10 * pathLossExponent));
            return Math.max(0.1, Math.min(10, distance));
        }

        function isPointInPolygon(point, polygon) {
            const x = point[0], y = point[1];
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];
                
                const intersect = ((yi > y) !== (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function getAdjustedPosition(position, distance) {
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é —Ç–æ—á–∫—É –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ –∫–æ–º–Ω–∞—Ç—ã
            const center = getRoomCenter();
            const direction = [
                position[0] - center[0],
                position[1] - center[1]
            ];
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            const length = Math.sqrt(direction[0] * direction[0] + direction[1] * direction[1]);
            const normalized = [direction[0] / length, direction[1] / length];
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—ã
            return [
                center[0] + normalized[0] * distance * 0.8,
                center[1] + normalized[1] * distance * 0.8
            ];
        }

        function getRoomCenter() {
            const lngs = PRECISE_ROOM_CORNERS.map(p => p[0]);
            const lats = PRECISE_ROOM_CORNERS.map(p => p[1]);
            return [
                (Math.min(...lngs) + Math.max(...lngs)) / 2,
                (Math.min(...lats) + Math.max(...lats)) / 2
            ];
        }

        function setupRoomVisualization() {
            // –ü–æ–ª–∏–≥–æ–Ω –∫–æ–º–Ω–∞—Ç—ã
            map.addSource('room', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: {
                        type: 'Polygon',
                        coordinates: [PRECISE_ROOM_CORNERS]
                    },
                    properties: {
                        name: 'EMIIA.AI MRV - –ó–æ–Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏—è'
                    }
                }
            });

            map.addLayer({
                id: 'room-fill',
                type: 'fill',
                source: 'room',
                paint: {
                    'fill-color': '#0080ff',
                    'fill-opacity': 0.15
                }
            });

            map.addLayer({
                id: 'room-border',
                type: 'line',
                source: 'room',
                paint: {
                    'line-color': '#0080ff',
                    'line-width': 3
                }
            });

            // –ó–æ–Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏—è Wi-Fi
            map.addSource('wifi-coverage', {
                type: 'geojson',
                data: createCoverageCircle(PRECISE_ROUTER_POSITION, 10) // 10–º —Ä–∞–¥–∏—É—Å
            });

            map.addLayer({
                id: 'wifi-coverage-fill',
                type: 'fill',
                source: 'wifi-coverage',
                paint: {
                    'fill-color': '#00ff00',
                    'fill-opacity': 0.1
                }
            });
        }

        function createCoverageCircle(center, radiusMeters) {
            const points = 32;
            const coords = [];
            
            for (let i = 0; i < points; i++) {
                const radians = (i / points) * 2 * Math.PI;
                const dx = radiusMeters * Math.cos(radians);
                const dy = radiusMeters * Math.sin(radians);
                
                const latOffset = dy / 111320;
                const lngOffset = dx / (111320 * Math.cos(center[1] * Math.PI / 180));
                
                coords.push([center[0] + lngOffset, center[1] + latOffset]);
            }
            
            coords.push(coords[0]);
            
            return {
                type: 'Feature',
                geometry: {
                    type: 'Polygon',
                    coordinates: [coords]
                }
            };
        }

        function addRouterMarker() {
            new mapboxgl.Marker({
                color: '#ff4444',
                scale: 1.3
            })
            .setLngLat(PRECISE_ROUTER_POSITION)
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML(`
                    <div style="padding: 10px; max-width: 250px;">
                        <h3 style="margin: 0 0 8px 0; color: #ff4444;">üì° EMIIA.AI MRV</h3>
                        <div style="font-size: 11px; font-family: monospace;">
                            <div><strong>MAC:</strong> 28-CD-C4-13-EE-A3</div>
                            <div><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong></div>
                            <div>–®: ${PRECISE_ROUTER_POSITION[1].toFixed(8)}</div>
                            <div>–î: ${PRECISE_ROUTER_POSITION[0].toFixed(8)}</div>
                        </div>
                    </div>
                `)
            )
            .addTo(map);

            document.getElementById('routerLat').textContent = PRECISE_ROUTER_POSITION[1].toFixed(8);
            document.getElementById('routerLng').textContent = PRECISE_ROUTER_POSITION[0].toFixed(8);
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function startPositioning() {
            if (isPositioningActive) return;
            
            isPositioningActive = true;
            updateSystemStatus('üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Wi-Fi —Å–µ—Ç–∏...', 'status-scanning');
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            positioningInterval = setInterval(updatePosition, 1500);
            updatePosition();
        }

        function stopPositioning() {
            isPositioningActive = false;
            clearInterval(positioningInterval);
            
            updateSystemStatus('‚è∏Ô∏è –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'status-offline');
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function calibrateSystem() {
            updateSystemStatus('üéöÔ∏è –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –º–æ–¥–µ–ª–∏ —Å–∏–≥–Ω–∞–ª–∞...', 'status-scanning');
            
            setTimeout(() => {
                updateSystemStatus('‚úÖ –ú–æ–¥–µ–ª—å –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–∞', 'status-online');
                showNotification('–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–∞ –¥–ª—è EMIIA.AI MRV', 'success');
            }, 2000);
        }

        function toggleTrainingMode() {
            trainingMode = !trainingMode;
            const trainingSection = document.getElementById('trainingSection');
            const trainingBtn = document.getElementById('trainingBtn');
            
            if (trainingMode) {
                trainingSection.classList.remove('hidden');
                trainingBtn.innerHTML = '<div class="icon">üìö</div> –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º';
                trainingBtn.className = 'btn btn-secondary';
                showNotification('–†–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è: –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Ç–æ—á–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏', 'info');
            } else {
                trainingSection.classList.add('hidden');
                trainingBtn.innerHTML = '<div class="icon">üéì</div> –û–±—É—á–µ–Ω–∏–µ';
                trainingBtn.className = 'btn btn-warning';
            }
        }

        function addTrainingPoint() {
            const pointName = document.getElementById('pointName').value || `–¢–æ—á–∫–∞_${Date.now()}`;
            const currentCenter = map.getCenter();
            
            const pointsList = document.getElementById('trainingPointsList');
            const pointElement = document.createElement('div');
            pointElement.className = 'coord-display';
            pointElement.innerHTML = `
                <div class="coord-label">${pointName}</div>
                <div class="coord-value">
                    ${currentCenter.lat.toFixed(8)}, ${currentCenter.lng.toFixed(8)}
                </div>
            `;
            pointsList.appendChild(pointElement);
            
            new mapboxgl.Marker({
                color: '#ffa500'
            })
            .setLngLat([currentCenter.lng, currentCenter.lat])
            .setPopup(new mapboxgl.Popup()
                .setHTML(`<strong>${pointName}</strong><br>RSSI: ${currentRSSI} dBm`)
            )
            .addTo(map);
            
            document.getElementById('pointName').value = '';
            showNotification(`–¢–æ—á–∫–∞ "${pointName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ (RSSI: ${currentRSSI} dBm)`, 'success');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updatePosition() {
            if (!isPositioningActive) return;

            // –°–∏–º—É–ª—è—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è RSSI —Å —É—á–µ—Ç–æ–º —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            currentRSSI = -40 - Math.random() * 25; // –û—Ç -40 –¥–æ -65 dBm
            
            const position = positioningSystem.estimatePosition(currentRSSI);
            updatePositionDisplay(position);
            updateStatistics(position);
            updateCount++;
        }

        function updatePositionDisplay(position) {
            document.getElementById('currentLat').textContent = position.point[1].toFixed(8);
            document.getElementById('currentLng').textContent = position.point[0].toFixed(8);
            document.getElementById('accuracyValue').textContent = position.accuracy.toFixed(2);

            updatePositionMarker(position.point);
        }

        function updatePositionMarker(coordinates) {
            if (window.positionMarker) {
                window.positionMarker.remove();
            }

            window.positionMarker = new mapboxgl.Marker({
                color: '#00ff00',
                scale: 1.1
            })
            .setLngLat(coordinates)
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML(`
                    <div style="padding: 8px;">
                        <h4 style="margin: 0 0 6px 0; color: #00ff00;">üìç –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è</h4>
                        <div style="font-size: 10px; font-family: monospace;">
                            <div>–®: ${coordinates[1].toFixed(8)}</div>
                            <div>–î: ${coordinates[0].toFixed(8)}</div>
                            <div>RSSI: ${currentRSSI} dBm</div>
                        </div>
                    </div>
                `)
            )
            .addTo(map);

            map.flyTo({
                center: coordinates,
                essential: true,
                duration: 800
            });
        }

        function updateStatistics(position) {
            document.getElementById('updateCount').textContent = updateCount;
            document.getElementById('confidenceValue').textContent = Math.round(position.confidence * 100) + '%';
            document.getElementById('rssiValue').textContent = currentRSSI.toFixed(1) + ' dBm';
            document.getElementById('distanceValue').textContent = position.distance.toFixed(1) + ' –º';
        }

        function updateSystemStatus(message, className) {
            const statusElement = document.getElementById('systemStatus');
            const icon = className.includes('online') ? '‚úÖ' : className.includes('scanning') ? 'üîç' : '‚è∏Ô∏è';
            statusElement.innerHTML = `<div class="icon">${icon}</div><span>${message}</span>`;
            statusElement.className = `status-indicator ${className}`;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#cce7ff'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#004085'};
                padding: 12px 16px;
                border-radius: 8px;
                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#b3d7ff'};
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 300px;
                word-wrap: break-word;
                font-size: 0.9em;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            
            if (mapboxgl.accessToken.includes('fake_token')) {
                showNotification('–ó–∞–º–µ–Ω–∏—Ç–µ Mapbox —Ç–æ–∫–µ–Ω –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π!', 'error');
            }
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.startPositioning = startPositioning;
        window.stopPositioning = stopPositioning;
        window.calibrateSystem = calibrateSystem;
        window.toggleTrainingMode = toggleTrainingMode;
        window.addTrainingPoint = addTrainingPoint;
    </script>
</body>
</html>
