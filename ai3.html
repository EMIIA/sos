<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Чат с авторастягивающимся полем ввода</title>
<style>
  :root {
    --user-bg: #e3f2fd;
    --assistant-bg: #f5f5f5;
    --error: #ff4444;
  }

  body, html {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
  }

  .container {
    position: relative;
    height: 100vh;
    display: flex;
    flex-direction: column;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    box-sizing: border-box;
    transition: transform 0.3s ease;
  }

  .container.active {
    transform: translateY(-20%);
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scroll-behavior: smooth;
    overscroll-behavior: contain;
    min-height: 0;
  }

  .message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 15px;
    line-height: 1.4;
  }

  .user {
    background: var(--user-bg);
    align-self: flex-end;
  }

  .assistant {
    background: var(--assistant-bg);
    align-self: flex-start;
  }

  .loading {
    display: inline-flex;
    gap: 6px;
    padding: 12px 16px;
  }

  .dot {
    width: 8px;
    height: 8px;
    background: #666;
    border-radius: 50%;
    animation: bounce 1s infinite;
  }

  textarea {
    width: 100%;
    min-height: 40px;
    max-height: 200px;
    padding: 12px;
    font-size: 16px;
    resize: none;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-top: 20px;
    box-sizing: border-box;
    transition: all 0.3s ease;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }
</style>
</head>
<body>
  <div class="container" id="block">
    <div id="messages"></div>
    <textarea 
      id="input" 
      placeholder="Введите сообщение..."
      rows="1"
    ></textarea>
  </div>

<script>
  const API_KEY = 'Z6GzPXyjyeG26SimUqFRKGAnIpVPOgMu';
  const API_URL = 'https://api.mistral.ai/v1/chat/completions';
  let isProcessing = false;
  let history = JSON.parse(localStorage.getItem('chatHistory')) || [];
  const container = document.getElementById('block');
  const input = document.getElementById('input');

  // Инициализация чата
  renderHistory();
  adjustTextareaHeight(input);

  // Поднимаем блок при фокусе
  input.addEventListener('focus', () => container.classList.add('active'));
  input.addEventListener('blur', () => container.classList.remove('active'));

  function adjustTextareaHeight(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
    if(document.activeElement === textarea) container.classList.add('active');
  }

  async function sendMessage() {
    if (isProcessing || !API_KEY) return;
    
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    isProcessing = true;
    adjustTextareaHeight(input);
    addMessage('user', message);
    
    try {
      const loader = addLoader();
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: "mistral-tiny",
          messages: [...history, { role: "user", content: message }],
          temperature: 0.7
        })
      });

      if (!response.ok) throw new Error(`Ошибка HTTP: ${response.status}`);
      
      const data = await response.json();
      const reply = data.choices[0].message.content;
      
      addMessage('assistant', reply);
      history = [...history, 
        { role: "user", content: message },
        { role: "assistant", content: reply }
      ];
      saveHistory();

    } catch (error) {
      showError(error.message);
    } finally {
      isProcessing = false;
      removeLoader();
    }
  }

  function addMessage(role, content) {
    const messages = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.textContent = content;
    messages.appendChild(div);
    
    requestAnimationFrame(() => {
      messages.scrollTo({
        top: messages.scrollHeight,
        behavior: 'smooth'
      });
    });
  }

  function renderHistory() {
    history.forEach(msg => addMessage(msg.role, msg.content));
  }

  function saveHistory() {
    localStorage.setItem('chatHistory', JSON.stringify(history));
  }

  function addLoader() {
    const loader = document.createElement('div');
    loader.className = 'message assistant loading';
    loader.innerHTML = `
      <div class="dot"></div>
      <div class="dot" style="animation-delay: 0.2s"></div>
      <div class="dot" style="animation-delay: 0.4s"></div>
    `;
    document.getElementById('messages').appendChild(loader);
    return loader;
  }

  function removeLoader() {
    document.querySelector('.loading')?.remove();
  }

  function showError(message) {
    const error = document.createElement('div');
    error.className = 'message assistant';
    error.style.color = 'var(--error)';
    error.textContent = `Ошибка: ${message}`;
    document.getElementById('messages').appendChild(error);
  }

  input.addEventListener('input', () => adjustTextareaHeight(input));
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>
</body>
</html>

